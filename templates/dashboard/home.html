{% extends "base.html" %}
{% block title %}Dashboard — BizAssistant{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">Dashboard</h2>
    <div>
        <a href="{% url 'accounts:assessment' %}" class="btn btn-outline-primary btn-sm">View Assessment</a>
        <form method="post" action="{% url 'tasks:regenerate' %}" class="d-inline ms-1"
              onsubmit="return confirm('This will replace your current plan with a freshly generated one. Continue?');">
            {% csrf_token %}
            <button type="submit" class="btn btn-outline-secondary btn-sm">Regenerate Plan</button>
        </form>
    </div>
</div>

{% if plan %}
<!-- Progress -->
<div class="card mb-4">
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="card-title mb-0">{{ plan.title }}</h5>
            <span class="badge bg-primary">{{ plan.completion_pct }}% complete</span>
        </div>
        <div class="progress" style="height: 12px;">
            <div class="progress-bar bg-success" style="width: {{ plan.completion_pct }}%"></div>
        </div>
        <small class="text-muted">{{ plan.starts_on }} — {{ plan.ends_on }}</small>
    </div>
</div>

<!-- Stats -->
{% if stats %}
<div class="row mb-4 g-3">
    <div class="col-6 col-md-3">
        <div class="card text-center h-100">
            <div class="card-body py-3">
                <h4 class="text-success mb-0">{{ stats.done }}</h4>
                <small class="text-muted">Completed</small>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="card text-center h-100">
            <div class="card-body py-3">
                <h4 class="mb-0">{{ stats.remaining }}</h4>
                <small class="text-muted">Remaining</small>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="card text-center h-100">
            <div class="card-body py-3">
                <h4 class="text-warning mb-0">{{ stats.skipped }}</h4>
                <small class="text-muted">Skipped</small>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="card text-center h-100">
            <div class="card-body py-3">
                <h4 class="{% if stats.overdue %}text-danger{% else %}text-muted{% endif %} mb-0">{{ stats.overdue }}</h4>
                <small class="text-muted">Overdue</small>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Streak & Achievements -->
<div class="row mb-4 g-3">
    <div class="col-md-4">
        <div class="card h-100">
            <div class="card-body text-center">
                <h1 class="display-4 {% if current_streak >= 7 %}text-warning{% elif current_streak >= 3 %}text-success{% else %}text-muted{% endif %} mb-1">{{ current_streak }}</h1>
                <p class="text-muted mb-0">Day Streak</p>
                {% if current_streak >= 7 %}
                <small class="text-warning">On fire!</small>
                {% elif current_streak >= 3 %}
                <small class="text-success">Building momentum!</small>
                {% elif current_streak == 0 %}
                <small class="text-muted">Complete a task to start your streak</small>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="col-md-8">
        <div class="card h-100">
            <div class="card-header fw-bold">Recent Achievements</div>
            <div class="card-body">
                {% if recent_achievements %}
                <ul class="list-unstyled mb-0">
                    {% for achievement in recent_achievements %}
                    <li class="mb-2">
                        <strong>{{ achievement.title }}</strong>
                        <br><small class="text-muted">{{ achievement.description }} &mdash; {{ achievement.earned_at|timesince }} ago</small>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-muted mb-0">Complete tasks to earn achievements!</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Plan Continuation Prompt -->
{% if continuation %}
<div class="alert alert-success d-flex justify-content-between align-items-center mb-4">
    <div>
        {% if continuation.reason == 'completed' %}
        <strong>Plan Complete!</strong> You've finished all tasks. Ready for your next phase?
        {% else %}
        <strong>Plan Expired.</strong> Your plan period has ended. Continue with a fresh phase?
        {% endif %}
    </div>
    <form method="post" action="{% url 'tasks:continue_plan' %}">
        {% csrf_token %}
        <button type="submit" class="btn btn-success btn-sm">Generate Next Phase</button>
    </form>
</div>
{% endif %}

<!-- Weekly Pulse Prompt -->
{% if not pulse_done_this_week %}
<div class="alert alert-primary d-flex justify-content-between align-items-center mb-4">
    <div>
        <strong>Weekly Check-in:</strong> How did your week go? Track your progress with a quick check-in.
    </div>
    <a href="{% url 'accounts:pulse' %}" class="btn btn-primary btn-sm">Check In</a>
</div>
{% endif %}

<!-- Today's Tasks -->
<h4 class="mb-3">Today's Tasks ({{ today }})</h4>
{% if today_tasks %}
{% for task in today_tasks %}
<div class="card mb-2">
    <div class="card-body d-flex justify-content-between align-items-center">
        <div>
            <h6 class="mb-1">
                <a href="{% url 'tasks:detail' task.pk %}">{{ task.title }}</a>
            </h6>
            <small class="text-muted">
                <span class="badge bg-secondary">{{ task.get_category_display }}</span>
                <span class="badge bg-info">{{ task.get_difficulty_display }}</span>
                ~{{ task.estimated_minutes }} min
            </small>
        </div>
        <div>
            <form method="post" action="{% url 'tasks:mark_done' task.pk %}" class="d-inline">
                {% csrf_token %}
                <input type="hidden" name="next" value="{% url 'accounts:dashboard' %}">
                <button type="submit" class="btn btn-sm btn-success">Done</button>
            </form>
            <form method="post" action="{% url 'tasks:mark_skip' task.pk %}" class="d-inline">
                {% csrf_token %}
                <input type="hidden" name="next" value="{% url 'accounts:dashboard' %}">
                <button type="submit" class="btn btn-sm btn-outline-warning">Skip</button>
            </form>
        </div>
    </div>
</div>
{% endfor %}
{% else %}
<div class="alert alert-success">No pending tasks for today. Great job!</div>
{% endif %}

<!-- Recently Completed -->
{% if recent_completed %}
<h5 class="mt-4 mb-3">Recently Completed</h5>
<ul class="list-group mb-4">
    {% for task in recent_completed %}
    <li class="list-group-item d-flex justify-content-between">
        <span><s>{{ task.title }}</s></span>
        <small class="text-muted">Day {{ task.day_number }}</small>
    </li>
    {% endfor %}
</ul>
{% endif %}

<!-- Upcoming -->
{% if upcoming_tasks %}
<h5 class="mt-4 mb-3">Coming Up</h5>
<ul class="list-group">
    {% for task in upcoming_tasks %}
    <li class="list-group-item d-flex justify-content-between">
        <span>{{ task.title }}</span>
        <small class="text-muted">{{ task.due_date }}</small>
    </li>
    {% endfor %}
</ul>
{% endif %}

{% else %}
<div class="alert alert-info">
    You don't have an active plan yet.
    <a href="{% url 'onboarding:step_1' %}">Start onboarding</a> to get your personalized plan.
</div>
{% endif %}
{% endblock %}
