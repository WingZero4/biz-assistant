{% extends "base.html" %}
{% block title %}Chat Advisor â€” BizAssistant{% endblock %}

{% block extra_css %}
<style>
#chat-container {
    height: 60vh;
    overflow-y: auto;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 1rem;
    background: #f8f9fa;
}
.msg-user, .msg-assistant {
    max-width: 80%;
    padding: 0.6rem 1rem;
    border-radius: 12px;
    margin-bottom: 0.5rem;
    word-wrap: break-word;
}
.msg-user {
    background: #0d6efd;
    color: #fff;
    margin-left: auto;
    text-align: right;
}
.msg-assistant {
    background: #fff;
    border: 1px solid #dee2e6;
}
#typing-indicator {
    display: none;
    color: #6c757d;
    font-style: italic;
    margin-bottom: 0.5rem;
}
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">Chat Advisor</h2>
    <form method="post" action="{% url 'accounts:chat_new_session' %}">
        {% csrf_token %}
        <button type="submit" class="btn btn-outline-secondary btn-sm">New Conversation</button>
    </form>
</div>

<div id="chat-container">
    {% for msg in history %}
    <div class="d-flex {% if msg.role == 'user' %}justify-content-end{% endif %}">
        <div class="msg-{{ msg.role }}">{{ msg.content|linebreaksbr }}</div>
    </div>
    {% endfor %}
    <div id="typing-indicator">Thinking...</div>
</div>

<form id="chat-form" class="mt-3">
    {% csrf_token %}
    <div class="input-group">
        <input type="text" id="chat-input" class="form-control" placeholder="Ask your business advisor..." autocomplete="off">
        <button type="submit" id="send-btn" class="btn btn-primary">Send</button>
    </div>
</form>

<script>
(function() {
    var container = document.getElementById('chat-container');
    var form = document.getElementById('chat-form');
    var input = document.getElementById('chat-input');
    var sendBtn = document.getElementById('send-btn');
    var typing = document.getElementById('typing-indicator');
    var sessionId = '{{ session_id }}';

    // CSRF token from cookie
    function getCookie(name) {
        var value = '; ' + document.cookie;
        var parts = value.split('; ' + name + '=');
        if (parts.length === 2) return parts.pop().split(';').shift();
    }

    function scrollToBottom() {
        container.scrollTop = container.scrollHeight;
    }

    function addMessage(role, content) {
        var wrapper = document.createElement('div');
        wrapper.className = 'd-flex ' + (role === 'user' ? 'justify-content-end' : '');
        var bubble = document.createElement('div');
        bubble.className = 'msg-' + role;
        // Safe: use textContent + DOM <br> elements to prevent XSS
        var lines = content.split('\n');
        lines.forEach(function(line, i) {
            bubble.appendChild(document.createTextNode(line));
            if (i < lines.length - 1) {
                bubble.appendChild(document.createElement('br'));
            }
        });
        wrapper.appendChild(bubble);
        container.insertBefore(wrapper, typing);
        scrollToBottom();
    }

    function setLoading(loading) {
        typing.style.display = loading ? 'block' : 'none';
        sendBtn.disabled = loading;
        input.disabled = loading;
        if (loading) scrollToBottom();
    }

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        var message = input.value.trim();
        if (!message) return;

        addMessage('user', message);
        input.value = '';
        setLoading(true);

        var formData = new FormData();
        formData.append('message', message);
        formData.append('session_id', sessionId);

        fetch('{% url "accounts:chat_send" %}', {
            method: 'POST',
            headers: { 'X-CSRFToken': getCookie('csrftoken') },
            body: formData,
        })
        .then(function(res) { return res.json(); })
        .then(function(data) {
            setLoading(false);
            if (data.reply) {
                addMessage('assistant', data.reply);
            } else if (data.error) {
                addMessage('assistant', 'Error: ' + data.error);
            }
        })
        .catch(function(err) {
            setLoading(false);
            addMessage('assistant', 'Something went wrong. Please try again.');
        });
    });

    // Focus input and scroll to bottom on load
    scrollToBottom();
    input.focus();
})();
</script>
{% endblock %}
